version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing dependencies..."
            - pip install -r requirements.txt
            - echo "Retrieving GCP credentials from AWS Secrets Manager..."
            # Retrieve the secret from Secrets Manager and write it to secrets.json.
            - aws secretsmanager get-secret-value --secret-id gcs/secrets/lucano --query 'SecretString' --output text > secrets.json
            - export GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/secrets.json
            - echo "GOOGLE_APPLICATION_CREDENTIALS is set to $(pwd)/secrets.json"
        build:
          commands:
            - echo "Starting the server..."
            - uvicorn main:app --host 0.0.0.0 --port 8000
      artifacts:
        baseDirectory: static
        files:
          - '**/*'
